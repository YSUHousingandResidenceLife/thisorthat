<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>This or That â€” Housing Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">

<!-- ðŸ”‘ IMPORT MAP (REQUIRED FOR GITHUB PAGES) -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
  }
}
</script>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:'Bungee',cursive;
}
#map{position:absolute;inset:0}

/* HUD */
#hud{
  position:absolute;
  bottom:28px;
  left:50%;
  transform:translateX(-50%);
  z-index:10;
  width:92%;
  max-width:900px;
}
.title{
  background:linear-gradient(90deg,#22c55e,#06b6d4,#a855f7);
  color:white;
  padding:18px;
  border-radius:18px;
  border:6px solid #000;
  text-align:center;
  font-size:1.6rem;
  margin-bottom:14px;
}
.question{
  background:#fde047;
  border:6px solid #000;
  border-radius:16px;
  padding:18px;
  text-align:center;
  font-size:1.8rem;
  margin-bottom:16px;
}
.answers{
  display:flex;
  gap:18px;
}
.answer{
  flex:1;
  padding:26px 20px;
  border-radius:18px;
  border:6px solid #000;
  cursor:pointer;
  text-align:center;
  font-size:1.2rem;
  box-shadow:0 10px 0 #000;
  transition:.15s;
}
.answer.left{background:#22c55e;color:#052e16}
.answer.right{background:#ef4444;color:#450a0a}
.answer:hover{transform:translateY(-6px);box-shadow:0 16px 0 #000}
.answer:active{transform:translateY(4px);box-shadow:0 6px 0 #000}
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  <div class="title">THIS OR THAT â€” HOUSING EDITION</div>
  <div class="question" id="qText"></div>
  <div class="answers">
    <div class="answer left" id="aLeft"></div>
    <div class="answer right" id="aRight"></div>
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

<script type="module">
/* ================= IMPORTS ================= */
import * as THREE from "three";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

/* ================= QUESTIONS ================= */
const questions = [
  { q:"HOUSING VIBE?", l:"Activities & Social", r:"Privacy & Quiet", loc:[-80.6482,41.1025] },
  { q:"SOCIAL STYLE?", l:"Meet Students", r:"Keep to Myself", loc:[-80.6485,41.1035] },
  { q:"DINING?", l:"Order & Eat", r:"Grocery & Cooking", loc:[-80.6490,41.1045] },
  { q:"RESIDENCY?", l:"Summers at Home", r:"Live Year-Round", loc:[-80.6500,41.1060] },
  { q:"FINANCES?", l:"One Bill / Aid", r:"Monthly Budget", loc:[-80.6515,41.1075] },
  { q:"SUPPORT?", l:"24/7 Staff Support", r:"Indie Problem Solving", loc:[-80.6505,41.1090] },
  { q:"CLEANING?", l:"Clean My Room", r:"Room, Bath & Living", loc:[-80.6480,41.1085] },
  { q:"CONTRACT?", l:"Flexible Study", r:"1-Year Lease", loc:[-80.6465,41.1072] }
];

let qIndex = 0;

/* ================= MAP ================= */
mapboxgl.accessToken =
'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

const map = new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
  center:questions[0].loc,
  zoom:16.8,
  pitch:60,
  bearing:-133.6
});

/* ================= RAINBOW BUILDINGS (SAFE) ================= */
map.on('load',()=>{
  const layers = map.getStyle().layers;
  layers.forEach(layer=>{
    if(layer.type === 'fill-extrusion'){
      map.setPaintProperty(layer.id,'fill-extrusion-color',[
        'rgba',
        ['random',['get','name'],0],
        ['random',['get','name'],1],
        ['random',['get','name'],2],
        1
      ]);
    }
  });
});

/* ================= THREE CUSTOM LAYER ================= */
const scene = new THREE.Scene();
const camera = new THREE.Camera();
const renderer = new THREE.WebGLRenderer({alpha:true});
renderer.autoClear = false;

const loader = new GLTFLoader();

const customLayer = {
  id:'three-layer',
  type:'custom',
  renderingMode:'3d',
  onAdd(map,gl){
    renderer.setSize(map.getCanvas().width,map.getCanvas().height);
    renderer.setPixelRatio(window.devicePixelRatio);
    map.getCanvasContainer().appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff,1.2));
  },
  render(gl,matrix){
    camera.projectionMatrix = new THREE.Matrix4().fromArray(matrix);
    renderer.resetState();
    renderer.render(scene,camera);
    map.triggerRepaint();
  }
};

map.on('load',()=>map.addLayer(customLayer));

/* ================= HELPERS ================= */
function lngLatToVector(lng,lat,height=0){
  const m = mapboxgl.MercatorCoordinate.fromLngLat({lng,lat},height);
  return new THREE.Vector3(m.x,m.y,m.z);
}

function dropTrafficLight([lng,lat],side){
  loader.load('./california_traffic_signal_median.glb',g=>{
    const obj = g.scene;
    obj.scale.setScalar(0.8);

    obj.traverse(m=>{
      if(m.isMesh){
        m.material = m.material.clone();
        m.material.color.set(side==='left'?0x22c55e:0xef4444);
      }
    });

    obj.position.copy(lngLatToVector(lng,lat,0));
    scene.add(obj);
  });
}

/* ================= GAME ================= */
function renderQuestion(){
  const q = questions[qIndex];
  if(!q){
    qText.innerText='DONE';
    document.querySelector('.answers').style.display='none';
    return;
  }
  qText.innerText = q.q;
  aLeft.innerText = q.l;
  aRight.innerText = q.r;
  map.flyTo({center:q.loc,speed:0.9,curve:1.2});
}

function choose(side){
  const q = questions[qIndex];
  dropTrafficLight(q.loc,side);
  qIndex++;
  renderQuestion();
}

aLeft.onclick = ()=>choose('left');
aRight.onclick = ()=>choose('right');

map.on('load',renderQuestion);
</script>

</body>
</html>
